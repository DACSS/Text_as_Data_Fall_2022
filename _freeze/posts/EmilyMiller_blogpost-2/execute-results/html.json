{
  "hash": "036ad40acf6574213c63c08f90eb9d7a",
  "result": {
    "markdown": "---\ntitle: \"Blog Post 2: Medical Textbook Acquisition\"\nauthor: \"Emily Miller\"\ndesription: \"Downloading medical textbooks through webscraping and OCR\"\ndate: \"10/02/2022\"\nformat:\n  html:\n    toc: true\n    code-fold: true\n    code-copy: true\n    code-tools: true\ncategories:\n  - hw2\n  - blogpost2\n  - Emily Miller\n  - internetarchivebooks\n  - internetarchive\n  - tidyverse\n  - polite\n  - rvest\n  - tesseract\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#load this here so I don't have to rerun everything\n# dat <- readr::read_csv(\"_data/out.csv\")\n# load(\"dat9.RData\")\n```\n:::\n\n\n# Recap\n\nQuestions:\n\n* Is there a difference in language use between penises and vulvas?\n* Is there a change in language use over time?\n\nHow: Compare language use in anatomy textbooks\n\n\n# Overview\n\nAcquiring textbooks from the Internet Archive (IA) took me multiple steps. On the IA website, there is an option to search through the text portion of a book. On the IA API, however, I couldn't find this option. The best I could find was looking through a book's metadata, which wasn't the same. When I looked for the word \"vagina\", this returned gynecology books and almost no anatomy books, compared to when I searched in the text. I decided to search \"vagina\" instead of \"genital\" because some anatomy books historically haven't reviewed the vagina/vulva. Because of this I performed the data review in multiple steps:\n\n1. Search \"vagina\" in the IA eBooks and Texts collection, using \"text contents\" search option.\n  + I later select \"English\" as the language to avoid non-English texts.\n2. Webscrape titles and years of publication from the results.\n3. Filter titles of interest.\n4. Use internetarchive package in conjunction with webscraping to download PDF files.\n\nI found that most of the texts I could download were from pre-1970. I requested titles retrieved from my IA search through the UMass library or through an inter-library loan, which were primarily PDFs like the IA data. I then processed both datasets:\n\n1. Remove headers/footer chapter titles\n2. Edit image backgrounds and transparency for OCR\n3. Use Tesseract to OCR\n\n# Internet Archive Data Retrieval\n### Part 1 and 2: Webscraping Titles from the IA Website\n\nI performed the search explained in step 1 above. As a note, when I tried to use \"AND\" to include both \"penis\" and \"vagina\", but when I flipped the order, a different number of results appeared. I confirmed with the IA API search manual I used the correct syntax. Because of this, I left the search-word at \"vagina\" since many texts historically don't include vaginal anatomy but will include penis'. \n\nIn order to confirm that I can webscrape, I use the package \"bow\" to check the website url. It says that I need a 5 minute delay.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbow(\"https://archive.org/details/texts?query=vagina\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<polite session> https://archive.org/details/texts?query=vagina\n    User-agent: polite R package\n    robots.txt: 2 rules are defined for 1 bots\n   Crawl delay: 5 sec\n  The path is scrapable for this user-agent\n```\n:::\n:::\n\n\nThe webpage has 2 options. There is infinite scrolling, but there is also a webscraping-friendly option which is with pages. I checked that the last page number is 133, so I make a set of urls to webscrape with through all these pages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#i found out that the max page number is 133, and starts at page 0\nurls<- paste0(\"https://archive.org/details/texts?query=vagina&sin=TXT&and[]=languageSorter%3A%22English%22&page=\",\n              0:133)\n\nurls %>% head\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"https://archive.org/details/texts?query=vagina&sin=TXT&and[]=languageSorter%3A%22English%22&page=0\"\n[2] \"https://archive.org/details/texts?query=vagina&sin=TXT&and[]=languageSorter%3A%22English%22&page=1\"\n[3] \"https://archive.org/details/texts?query=vagina&sin=TXT&and[]=languageSorter%3A%22English%22&page=2\"\n[4] \"https://archive.org/details/texts?query=vagina&sin=TXT&and[]=languageSorter%3A%22English%22&page=3\"\n[5] \"https://archive.org/details/texts?query=vagina&sin=TXT&and[]=languageSorter%3A%22English%22&page=4\"\n[6] \"https://archive.org/details/texts?query=vagina&sin=TXT&and[]=languageSorter%3A%22English%22&page=5\"\n```\n:::\n:::\n\n\nI want to retrieve the title of each result as well as the hyperlink to its page. I next practiced scraping from one webpage. Once I confirmed that the code worked, I put it into a function. This allows me to iteratively scrape pages using map_dfr(). I make sure to include a 5 second wait period after each page is webscraped. After map scrapes all the pages, the function outputs all the results into a dataframe (which is the dfr option) so I can begin manipulating them without much more pre-processing. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n#make a function that does all the work for me\nget_titles_dates<-function(aurl){\n  page<- read_html(aurl)\n  \n  #scrape titles \n  titles<- page %>% \n    html_elements(., xpath=\"//div[contains(concat(' ',normalize-space(@class),' '),' item-ttl C C2 ')]/a\") %>% \n    html_attr(\"title\")\n  \n  hrefs<- page %>% \n    html_elements(., xpath=\"//div[contains(concat(' ',normalize-space(@class),' '),' item-ttl C C2 ')]/a\") %>% \n    html_attr(\"href\")\n  \n  #combine\n  tempdat<- bind_cols(titles = titles, \n                      hrefs = hrefs)\n  \n  return(tempdat)\n}\n\n# iteratively scrape urls and return as a dataframe\ndat<-map_dfr(urls, ~{\n  Sys.sleep(5)\n  tryCatch({get_titles_dates(.x)},\n           error = function(e){\n             cat(\"\\n\\n\", .x, \"\\n\\n\") #report bad urls -- used for testing\n           })\n})\n\n##save data in case it crashes\n# save(dat, file = \"/Users/emmanuelmiller/Desktop/dacss697d/forblog/Text_as_Data_Fall_2022/posts/_data/hrefs.RData\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat %>% head\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 2\n  titles                                                                   hrefs\n  <chr>                                                                    <chr>\n1 A NEW HYGROMIIDAE FROM THE ITALIAN APENNINES AND NOTES ON THE GENUS CER… /det…\n2 Operative gynecology                                                     /det…\n3 Pathology of the uterine cervix, vagina, and vulva                       /det…\n4 Diseases of women: a manual of gynecology designed especially for the u… /det…\n5 A treatise on gynaecology, clinical and operative                        /det…\n6 The Principles and practice of gynecology : for students and practition… /det…\n```\n:::\n:::\n\n\n### Part 3: Clean and Select Titles of Interest\n\nI first need to clean the webscraped titles so I can identify duplicate uploads. This is because multiple users can upload the same book and all results are included in my search. I'll remove duplicates a bit further down.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#clean titles\ndat2<- dat %>% \n  mutate(original_titles = titles,\n         titles = trimws(titles, which = \"both\"),\n         titles = tolower(titles),\n         titles = str_replace_all(titles, c(\"[[:punct:]]|electronic resource\" = \" \",\n                                            \"æ\" = \"ae\",\n                                            \"\\\\bvol\\\\w*\" = \"\",\n                                            \"microform\" = \"\", \n                                            \"\\\\s+\" = \" \")), #theres extra punct at ends\n         titles = trimws(titles, which = \"both\")\n         ) %>% \n  select(-matches(\"\\\\.\")) %>% #get rid of the extra row that map gives us\n  unique\n\ndat2 %>% head\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 3\n  titles                                                           hrefs origi…¹\n  <chr>                                                            <chr> <chr>  \n1 a new hygromiidae from the italian apennines and notes on the g… /det… A NEW …\n2 operative gynecology                                             /det… Operat…\n3 pathology of the uterine cervix vagina and vulva                 /det… Pathol…\n4 diseases of women a manual of gynecology designed especially fo… /det… Diseas…\n5 a treatise on gynaecology clinical and operative                 /det… A trea…\n6 the principles and practice of gynecology for students and prac… /det… The Pr…\n# … with abbreviated variable name ¹​original_titles\n```\n:::\n:::\n\n\nI remove titles, following what I have described primarily in blog post 1 about my text selection criteria. Here I will go into further detail:\n\n* The text sources we are looking at are books, so sources such as \"essays\", \"journals\", \"encyclopedias\", \"ICD manuals\", \"studies\", catalogues\", \"experiments\", \"doctrines\", \"translations\" or \"memoirs\" are excluded.\n  + Others that fit in this category include books describing \"key facts\" or a topic, or \"idiot's guides\" that are also for the general public. \n  + Books that were primarily illustrations or coloring\n* Texts that aren't books but rather journals. This includes \"Current Operative Urology\", \"papers\", a report on a double uterus, and \"Surgical Clinics of North America\"\n* Excluding books specific to pathology or disease. Other studies have also excluded pathological conditions in their reviews of textbooks (Andrikopoulou et al., 2013; Hayes & Temple-Smith, 2021). The ways in which disease are described depending on genitals beyond the scope of this pilot study.\n  + Other synonyms visible in books include \"morbid\", \"cancer\", \"treatment\", \"gravid uterus\", and \"disorder\".\n* Excluding pediatric and adolescent gynecology books, and those specific to midwifery.  \n* Other books related to animals, marriage, sociology, philosophy weren't included.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat3<- dat2 %>% \n    filter(!str_detect(titles, \"essay|journ|memoi|ency|icd|cata|studies|experim\")) %>%\n  filter(!str_detect(titles, \"trans|doctrin|repor|iss|malign|notes|review\")) %>%\n  filter(!str_detect(titles, \"current operative urology|papers|double uterus|dysfunction\")) %>%\n  filter(!str_detect(titles, \"key|idiot|illustrated anatomy|colou*r|crash|treatis|cookbook\")) %>%\n  filter(str_detect(titles, \"anatomy|anatomical|urolog|clinic|surgical clinics of north america\")) %>%\n  filter(!str_detect(titles, \"patho|disea|morbid|canc|treatm|gravid|midwif\")) %>%\n  filter(!str_detect(titles, \"restora|pedia|adolescen|private parts\")) %>%\n  filter(!str_detect(titles, \"marr|achatinidae|cleistogamia|elephant|cow|cestoidea\")) %>%\n  filter(!str_detect(titles, \"myrmecophaga|snail|equine|omphalina|neniinae|philosoph\")) %>%\n  filter(!str_detect(titles, \"ariolimax|gaseopoa|horse|sociology|psycho|ants\")) %>%\n  filter(!str_detect(titles, \"sex|dog|anatomie des menschen|albolabris|disor\"))\n```\n:::\n\n\n### Part 4: Downloading Data and Making Metadata\n\nIn order to retrieve information on the publication date of each title, I use the internetarchive package. The hyperlink extracted earlier has the identifier that I can use to retrieve information. I found that the internetarchive 'ia_search()' function doesn't return as accurate information just looking up the name of the book. Searching using the identifier of the book only didn't work for one book. I looked it up on the website and I couldn't download the book anyway because of the copyright.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat4<- dat3 %>% \n  mutate(hrefs = str_extract(hrefs, \"(?<=details/).*(?=\\\\?q=vagina)\"),\n         hrefs = str_replace_all(hrefs, c(\"/.*\" = \"\"))) %>% \n  mutate(dates = map(hrefs, ~ia_search(c(\"identifier\" = .)) %>% \n                       ia_get_items %>% \n                       ia_metadata))\n\ndat5<- dat4 %>% \n  mutate(hmm = map(dates, ~nrow(.))) %>% \n  unnest(hmm) %>% \n  filter(hmm!=0)\n```\n:::\n\n\nI also retrieved information as to the confidence level of the OCR. If there is a confidence level reported, I select a cutoff of >85%. I also select books with a date reported which is greater than 1875.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#reshape data\ndat5<- dat5 %>% \n  mutate(dates = map(dates, . %>% \n                       filter(field %in% c(\"date\", \"ocr_detected_script_conf\")))) %>% \n  unnest(dates) %>% \n  pivot_wider(names_from = field, values_from = value ) \n\n#clean dates\ndat6<- dat5 %>% \n  rename(dates = date) %>% \n  mutate(dates = case_when(\n    dates == \"[n.d.]\" ~ NA_character_,\n    !is.na(dates)~ str_extract(dates, \"\\\\d{4}\"),\n    T~ NA_character_\n  )) %>% \n  mutate(dates = as.numeric(dates))\n  \n#filter\ndat6<- dat6 %>% \n  filter(ocr_detected_script_conf > 0.85 | is.na(ocr_detected_script_conf)) %>% \n  select(-ocr_detected_script_conf) %>% \n  filter(dates > 1875) %>% \n  filter(!is.na(dates))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat7 %>% select(titles, dates, hrefs) %>% head()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 3\n  titles                                                             dates hrefs\n  <chr>                                                              <dbl> <chr>\n1 researches in female pelvic anatomy                                 1892 rese…\n2 atlas of pelvic anatomy and gynecologic surgery                     2001 atla…\n3 clinical gynaecology medical and surgical                           1895 clin…\n4 contraception healthy choices a contraceptive clinic in a book      2009 cont…\n5 textbook of female urology and urogynaecology                       2001 text…\n6 the anatomy and physiology of obstetrics a short textbook for stu…  1969 anat…\n```\n:::\n:::\n\n\nI was originally going to use the internetarchive package to download the text versions of these books. I found that in some cases, I was not able to download some of the books because they contained \"due to issues with the item's content\" (according to the file that I did receive). When I looked the book up on the IA website, I could access a text version of the book. I webscraped versions of these books but they didn't have delimiters between different pages, which meant that I couldn't reasonably remove headers and footers like the PDF files that I retrieved from the library. I was concerned about the quality of the data for this reason. After review of the IA website, I found out that I could download PDF versions of many of these books. I also found out that the UMass Library had Adobe Acrobat editor. I decided that because this dataset is relatively small I would spend an afternoon editing these PDFs to have better data.\n\nI examined the url structure on the IA website for downloading PDFs. I used the previously-webscraped hyperlink to construct the url I would download PDFs from.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat7<- dat6 %>% \n  select(titles, dates, hrefs) %>% \n  mutate(url = paste0(\"https://archive.org/download/\",\n                      hrefs, \"/\", hrefs, \".pdf\"))\n```\n:::\n\n\nI then used download.file() to download iteratively the urls I constructed. This returned for me 68 PDFs. This is approximately the same number of results as webscraping.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsetwd(\"/Users/emmanuelmiller/Desktop/dacss697d/forblog/Text_as_Data_Fall_2022/posts/download_pdfs\")\n\ntemp<- dat7$url\n\nfor (url in temp){ \n  tryCatch({\n    download.file(url, destfile = basename(url), mode = \"wb\")\n    Sys.sleep(5)\n  }, error = function(e){\n    cat(\"\\n\\n\", url, \"\\n\\n\")\n  })\n}\n```\n:::\n\n\nI reviewed these PDFs to confirm that there were no duplicates and all files could be downloaded. I found that a number were in fact duplicates or did not fit the inclusion criteria (such as being journal articles). There were a total of 44 documents remaining. \n\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n```\nJoining, by = \"files\"\n```\n:::\n:::\n\n\nBelow is the distribution of dates of the IA texts. The majority of the books in the dataset are before the 1930s, which makes sense because copyrights expire within this time frame. The lack of titles in 2000s could greatly skew the sample for downstream analysis. I continue with data retrieval from the books I requested through inter-library loan in the same way I do for that of the IA texts in the next sections.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemp<- dat8 %>% \n  select(files, dates) %>% \n  unique %>% \n  mutate(after1970 = ifelse(dates > 1970, \"after\", \"before\"))\n\nia_hist<-ggplot(temp, aes(x = dates, fill = after1970))+\n  geom_histogram()\n# save(ia_hist, file = \"/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/ia_hist.RData\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nia_hist\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](EmilyMiller_blogpost-2_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n# OCR Text Data Acquisition\n### Part 1: PDF Header and Footer Removal\n\nI considered a number of options for removing headers/footers. I first tried online tools but they had paywalls. I considered command-line tools like GhostScript, PDFEdit, and Poppler. Unfortunately, the text in the PDFs were not centered consistently so I would have to use a program with a GUI functionality to manually find the edges of the text body. I tried using Fiji (A.k.a. ImageJ) which is a Java-based software used by scientists to edit and analyze images. The perk of this software is that you can edit stacks of images and review them rapidly. Unfortunately, my computer didn't have enough RAM to review at an efficient speed PDFs that were greater than 500 pages with the GUI utility. I considered partitioning these PDFs, but then I learned that UMass has a paid (but free to students) subscription to Adobe Acrobat DC which is made to edit all sorts of PDF files. This software has a functionality that automatically removes headers and footers from PDFs, but this functionality didn't work with my data. I assumed that if AI couldn't detect the headers/footers then it would be easier to take care of this manually using this software by cropping the documents.\n\nUsing Adobe Acrobat DC, I removed headers and footers. There were some pages at the end of books that advertised other books or scientific papers. I removed these pages as well. After removing the headers/footers, I exported these to PNGs of 300 DPI, as the OCR software that I am using requires this format. Using higher DPI resulted in much slower exporting and used a lot of storage on my computer. \n\n### Part 2: Preprocessing for OCR\n\nTo OCR, I considered two programs. I considered using Adobe Acrobat's built-in OCR functionality which has been used in the literature (related to medical records: Hsu et al., 2022; Nguyen et al., 2020, etc). I also considered the ocr() function from the Tesseract package, a widely used (specific to medical text OCR: Goodrum et al., 2020; Hsu et al., 2022; Liu et al., 2020; Rasmussen et al., 2011; and many more), free, OCR program. Both are used in the literature, but I was more partial to Tesseract because it is more frequently used in the extraction of medical text data. In a larger study, it would be interesting to compare the quality of the OCR of both softwares. I also liked that the Tesseract command-line software would allow me to play with OCR parameters manually unlike Adobe. I decided on use of the Tesseract package as I wanted more control over the OCR conditions and its frequent use in the literature. \n\nThe Tesseract vignette recommends a number of procedures for altering images that increase the quality of the OCR. This includes deskewing text, trimming whitespace, removing noise and artifacts, converting images to black and white (binarization), and changing the thickness of the characters (dialation/erosion). All my images were above 10px so I didn't have to resize them. Historical data is notoriously difficult to OCR. Many of my documents are in a serif font, which is problematic because the middle of letters is typically much thinner. \n\nI tried using 2 different programs, Magick and ImageJ2. I didn't use Magick (which is in R) because the software wasn't effective at removing background effects. Using ImageJ2 (v 2.9.0) I did the above preprocessing. To deskew, I used the following code and saved it in plugins/Analyze folder. I took the code from [this user](https://forum.image.sc/t/get-direction-from-directionality-using-an-ij1-macro/11550/6).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#@ ImagePlus imp\n#@ ResultsTable rt\n\nimport fiji.analyze.directionality.Directionality_\n\nd = new Directionality_()\n\nd.setImagePlus(imp)\nd.setMethod(Directionality_.AnalysisMethod.LOCAL_GRADIENT_ORIENTATION)\n\nd.computeHistograms()\nd.fitHistograms()\n\nresult = d.getFitAnalysis()\n\nmainDirection = Math.toDegrees(result[0][0])\n\nrt.incrementCounter()\nrt.addValue(\"Main Direction\", mainDirection)\nrt.show(\"Results\")\n```\n:::\n\n\nI ran the following ImageJ2 macro on my dataset. This script took several hours to run because image processing is a computationally heavy task. In addition to this, I selected time images and used the \"erode\" feature.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninput = \"/Volumes/em_2022/good_pngs/\";\noutput = \"/Volumes/em_2022/good_tiffs/\";\nfileList = getFileList(input);\n\nfunction action(input, output, filename) {\n    open(input + filename);\n    \n    //clean up\n    run(\"Sharpen\");\n\t  run(\"Despeckle\");\n\t  run(\"Gaussian Blur...\", \"sigma=1\");\n    \n\t  //make binary\n\t  run(\"Sharpen\");\n\t  \n\t\trun(\"Find Maxima...\", \"prominence=10 exclude light output=Count\");\n\t\tx = getResult(\"Count\", 0);\n\t\tif (x > 50){\n\t\t  //for the black and white images that have the black box\n\t\t  if (bitDepth!=24) {\n\t\t    run(\"Find Maxima...\", \"prominence=10 exclude light output=[Point Selection]\");\n\t\t\t  run(\"Fit Rectangle\");\n\t\t\t  run(\"Enlarge...\", \"enlarge=60\");\n\t\t\t  run(\"Crop\");\n\t\t  }\n\t\t  \n\t\t  run(\"Subtract Background...\", \"rolling=100 light\");\n\t\t  run(\"Sharpen\");\n\t\t  run(\"Smooth\");\n\t  \trun(\"Convert to Mask\");\n\t\t  \n\t\t}\n\n\t  //crop\n\t  run(\"Select Bounding Box\");\n\t  run(\"Enlarge...\", \"enlarge=50\");\n\t  run(\"Crop\");\n\n\t\n\t  //transform\n\t  if (x > 50){\n\t    selectWindow(filename);\n  \t  \trun(\"Select Bounding Box\");\n    \trun(\"Copy\");\n    \trun(\"Create Mask\");\n    \ttitle_mask = getTitle();\n    \tselectWindow(title_mask);\n    \trun(\"Paste\");\n    \trun(\"Gaussian Blur...\", \"sigma=30\");\n    \trun(\"Enhance Contrast...\", \"saturated=0.1\");\n    \trun(\"Clear Results\");\n    \trun(\"Get Main Direction\", \"rt=[title=Results, size=1, hdr= \\tMain Direction]\");\n    \tangle = getResult(\"Main Direction\", 0);\n    \tangle = angle * -1.0;\n    \tif (abs(angle) < 30){\n    \t  selectWindow(filename);\n  \t    run(\"Rotate... \", \"angle=\"+ angle+  \" grid=1 interpolation=Bilinear fill\");\n    \t}\t\n      \tselectWindow(title_mask);\n  \t  \tclose();\n\t  }\n  \t\n\t  //remove results window\n\t  selectWindow(\"Results\"); \n\t  run(\"Clear Results\");\n\t  run(\"Close\");\n\t  \n\t  saveAs(\"Tiff\", output + filename);\n    close();\n}\n\t\nfor (i = 0; i < fileList.length; i++){\n\taction(input, output, fileList[i]);      \n}\n```\n:::\n\n\nBelow is an example of the clean image.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmagick::image_read(\"posts/_data/edited_b2041349x_001_Page_047.png\") %>% \n  print\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in magick_image_readpath(path, density, depth, strip, defines): R: UnableToOpenBlob `posts/_data/edited_b2041349x_001_Page_047.png': No such file or directory @ error/blob.c/OpenBlob/2924\n```\n:::\n\n```{.r .cell-code}\nmagick::image_read(\"posts/_data/1edited_b2041349x_001_Page_047.tif\") %>% \n  magick::image_background(color = \"black\") %>% \n  print\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in magick_image_readpath(path, density, depth, strip, defines): R: UnableToOpenBlob `posts/_data/1edited_b2041349x_001_Page_047.tif': No such file or directory @ error/blob.c/OpenBlob/2924\n```\n:::\n:::\n\n\n### Part3: Tesseract OCR\n\nIt is possible to provide Tesseract with an updated dictionary as well as pages to OCR in its database. Users have to re-render the model after doing this. I tried to add just to the dictionary (using vocabulary I made which I will describe in my next blog post). Unfortunately, my computer crashed. Given greater computational resources, this would be an avenue to follow to improve the accuracy of the OCR. For the purposes of this pilot study, I instead used the following loop to save text to a separate file. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsetwd(\"/Users/emmanuelmiller/Desktop/text_ia\")\n\ntemp<- tibble(files = list.files())\n\n#ocr and save to files\nfor(i in 1:nrow(temp)){\n  filename <- temp$files[i]\n  dat <- tesseract::ocr(filename)\n  cat(dat, file = file(paste0(basename(filename), \".txt\")), sep = \"\\n\")\n}\n```\n:::\n\n\nBelow is an example of some of the raw OCR data. I will demonstrate how I clean it in the next blog post.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbook_peek<- tibble(files = list.files(\"/Users/emmanuelmiller/Desktop/text_ia/\",\n                                      full.names = T)) %>% \n  slice(40:50) %>% \n  mutate(dat = map(files, ~str_c(read_lines(.), collapse = \"\\n\")),\n         dat = str_sub(dat, 0, 250),\n         url = str_extract(files, \"(?<=edit\\\\w{0,3}_).*(?=_Page)\"),\n         page = str_extract(files, \"(?<=Page_)\\\\d+\")) %>% \n  select(url, page, dat) %>% \n  kable %>% \n  kable_styling()\n  \n# save(book_peek, file = \"/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/book_peek.RData\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nbook_peek\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> url </th>\n   <th style=\"text-align:left;\"> page </th>\n   <th style=\"text-align:left;\"> dat </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 040 </td>\n   <td style=\"text-align:left;\"> A’. The peroneal artery, a branch of the posterior tibial,\ndescends vertically along the posterior aspect of the fibula as far\nas the lower tibio-fibular articulation, being covered above by the\nsoleus, then lying between the flexor longus pollicis a </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 041 </td>\n   <td style=\"text-align:left;\"> If. LicaTtuRE oF THE UpreR Part or THE ANTERIOR TIBIAL\nARTERY.\n\n(1). At rather more than an inch external to the crest of the\ntibia, and in the course of a line which would extend from the\nhead of the fibula to the'centre of the) ankle joint make an </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 042 </td>\n   <td style=\"text-align:left;\"> PLATE XIV.\nLIGATURE OF THE POSTERIOR TIBIAL ARTERY.\nFig. 1.—ANaTomy.\n\n1. The patella. 2. Internal malleolus. 3. Internal surface\nof the tibia. 4. Internal aponeurosis. 5. Soleus muscle drawn\nbackwards.\n\nA. The posterior tibial artery commencing at th </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 043 </td>\n   <td style=\"text-align:left;\"> @\nd, the common flexor ; ¢, the posterior tibial nerve; A, the\nartery.\nIncision No. 3.—Ligature of the upper third of the posterior tibial\nartery.\n\na, The skin ; 6, the aponeurosis ; c, the gastrocnemius drawn\nback by a retractor; d, an incision made </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 044 </td>\n   <td style=\"text-align:left;\"> (4). Whilst these muscles are held backwards and outwards .\nby a retractor, divide upon a director the deep aponeurotic fascia,\nbeneath which can be seen the vessels. (\n\n(5). Isolate the artery, and pass the ligature with either a\nCooper’s or a Desch </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 045 </td>\n   <td style=\"text-align:left;\"> PLATE XV.\nLIGATURE OF THE POPLITEAL ARTERY.\nFigs. 1, 2, and 3.—ANaToMY.\n\nFig. 1.—Aponeurotic layer, superficial cessels and nerves. .\n\n1—1. Popliteal aponeurosis in part removed. 2. Semi-\nmembranosus. 3. Biceps. 4. Cutaneous vessels and nerves.\n5. In </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 046 </td>\n   <td style=\"text-align:left;\"> lower part of the artery is somewhat internal and at the upper\npart external to the artery. These two vessels are covered\nsuperiorly by the belly of the semi-membranosus (1), and at\nthe lower part by the two bellies of the gastrocnemius (2 and 3).\nTh </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 047 </td>\n   <td style=\"text-align:left;\"> (4). Recognize the outer border of the semimembranosus\nmuscle, and the popliteal nerve will be now seen coming from\nbeneath it.\n\n(5). Push the nerve inwards, and beneath and a little internal\nto it will be found the popliteal vein.\n\n(6). Isolate the </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 048 </td>\n   <td style=\"text-align:left;\"> PLATE XVI.\nLIGATURE OF THE FEMORAL ARTERY.\nFig. 1.—ANaTOMY.\n\nA. The femoral artery, a continuation of the external iliac,\nextends from the middle of the crural arch (1) to the end of\nHunter's canal, where it becomes the popliteal. The vessel is\nin fr </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 049 </td>\n   <td style=\"text-align:left;\"> d, internal saphenous nerve ; ¢, tendinous sheath of the femoral\n\nveasels at Hunter's canal ; A, the artery.\n\nIncision No. 2.—Ligature of , the femoral artery im its upper\nird,\n\n@, the skin and cellular tissue; 6, aponeurosis; c, sheath\nof the femora </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> atextbookoperat00huetgoog </td>\n   <td style=\"text-align:left;\"> 050 </td>\n   <td style=\"text-align:left;\"> which unites the vessels together, and pass the ligature from\nbebind forwards.\n\nLigature of the femoral artery in the middle of the thigh.\n\nHUNTER’S OPERATION.\nFig. 2, Incision 2.\n\nThe limb being placed as in the preceding operation—\n\n(1). Make an in </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n# References\n\nGoodrum H, Roberts K, Bernstam EV. Automatic classification of scanned electronic health record documents. Int J Med Inform. 2020 Dec;144:104302. doi: 10.1016/j.ijmedinf.2020.104302. Epub 2020 Oct 17. PMID: 33091829; PMCID: PMC7731898. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7731898/\n\nHsu E, Malagaris I, Kuo YF, Sultana R, Roberts K. Deep learning-based NLP data pipeline for EHR-scanned document information extraction. JAMIA Open. 2022 Jun 11;5(2):ooac045. doi: 10.1093/jamiaopen/ooac045. PMID: 35702624; PMCID: PMC9188320. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9188320/ \n\nLiu X, Meehan J, Tong W, Wu L, Xu X, Xu J. DLI-IT: a deep learning approach to drug label identification through image and text embedding. BMC Med Inform Decis Mak. 2020 Apr 15;20(1):68. doi: 10.1186/s12911-020-1078-3. PMID: 32293428; PMCID: PMC7158001. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7158001/\n\nNguyen, A., O'Dwyer, J., Vu, T., Webb, P. M., Johnatty, S. E., & Spurdle, A. B. (2020). Generating high-quality data abstractions from scanned clinical records: text-mining-assisted extraction of endometrial carcinoma pathology features as proof of principle. BMJ open, 10(6), e037740. https://doi.org/10.1136/bmjopen-2020-037740 https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7295399/\n\nRasmussen LV, Peissig PL, McCarty CA, Starren J. Development of an optical character recognition pipeline for handwritten form fields from an electronic health record. J Am Med Inform Assoc. 2012 Jun;19(e1):e90-5. doi: 10.1136/amiajnl-2011-000182. Epub 2011 Sep 2. PMID: 21890871; PMCID: PMC3392858.https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3392858/\n\n\n",
    "supporting": [
      "EmilyMiller_blogpost-2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}