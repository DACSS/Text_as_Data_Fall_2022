<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Emily Miller">
<meta name="dcterms.date" content="2022-10-02">

<title>Text-as-Data Fall 2022 - Blog Post 2: Medical Textbook Acquisition</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/DACSS_Round_Network.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<meta name="twitter:title" content="Text-as-Data Fall 2022 - Blog Post 2: Medical Textbook Acquisition">
<meta name="twitter:description" content="Questions:">
<meta name="twitter:creator" content="@UMassDACSS">
<meta name="twitter:site" content="@UMassDACSS">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/UMass White Wordmark Horiz.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Text-as-Data Fall 2022</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://dacss.github.io/Text_as_Data_Fall_2022/">
 <span class="menu-text">Fall 2022</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">Contributors</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://umass.edu/sbs/dacss">
 <span class="menu-text">DACSS</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/DACSS/Text_as_Data_Fall_2022"><i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#recap" id="toc-recap" class="nav-link active" data-scroll-target="#recap">Recap</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#internet-archive-data-retrieval" id="toc-internet-archive-data-retrieval" class="nav-link" data-scroll-target="#internet-archive-data-retrieval">Internet Archive Data Retrieval</a>
  <ul class="collapse">
  <li><a href="#part-1-and-2-webscraping-titles-from-the-ia-website" id="toc-part-1-and-2-webscraping-titles-from-the-ia-website" class="nav-link" data-scroll-target="#part-1-and-2-webscraping-titles-from-the-ia-website">Part 1 and 2: Webscraping Titles from the IA Website</a></li>
  <li><a href="#part-3-clean-and-select-titles-of-interest" id="toc-part-3-clean-and-select-titles-of-interest" class="nav-link" data-scroll-target="#part-3-clean-and-select-titles-of-interest">Part 3: Clean and Select Titles of Interest</a></li>
  <li><a href="#part-4-downloading-data-and-making-metadata" id="toc-part-4-downloading-data-and-making-metadata" class="nav-link" data-scroll-target="#part-4-downloading-data-and-making-metadata">Part 4: Downloading Data and Making Metadata</a></li>
  </ul></li>
  <li><a href="#ocr-text-data-acquisition" id="toc-ocr-text-data-acquisition" class="nav-link" data-scroll-target="#ocr-text-data-acquisition">OCR Text Data Acquisition</a>
  <ul class="collapse">
  <li><a href="#part-1-pdf-header-and-footer-removal" id="toc-part-1-pdf-header-and-footer-removal" class="nav-link" data-scroll-target="#part-1-pdf-header-and-footer-removal">Part 1: PDF Header and Footer Removal</a></li>
  <li><a href="#part-2-preprocessing-for-ocr" id="toc-part-2-preprocessing-for-ocr" class="nav-link" data-scroll-target="#part-2-preprocessing-for-ocr">Part 2: Preprocessing for OCR</a></li>
  <li><a href="#part3-tesseract-ocr" id="toc-part3-tesseract-ocr" class="nav-link" data-scroll-target="#part3-tesseract-ocr">Part3: Tesseract OCR</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Blog Post 2: Medical Textbook Acquisition</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">hw2</div>
    <div class="quarto-category">blogpost2</div>
    <div class="quarto-category">Emily Miller</div>
    <div class="quarto-category">internetarchivebooks</div>
    <div class="quarto-category">internetarchive</div>
    <div class="quarto-category">tidyverse</div>
    <div class="quarto-category">polite</div>
    <div class="quarto-category">rvest</div>
    <div class="quarto-category">tesseract</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Emily Miller </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 2, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#load this here so I don't have to rerun everything</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># dat &lt;- readr::read_csv("_data/out.csv")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load("dat9.RData")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="recap" class="level1">
<h1>Recap</h1>
<p><strong>Questions:</strong></p>
<ul>
<li>Is there a difference in language use between penises and vulvas?</li>
<li>Is there a change in language use over time?</li>
</ul>
<p><strong>How:</strong> Compare language use in anatomy textbooks</p>
</section>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>Acquiring textbooks from the Internet Archive (IA) took me multiple steps. On the IA website, there is an option to search through the text portion of a book. On the IA API, however, I couldn’t find this option. The best I could find was looking through a book’s metadata, which wasn’t the same. When I looked for the word “vagina”, this returned gynecology books and almost no anatomy books, compared to when I searched in the text. I decided to search “vagina” instead of “genital” because some anatomy books historically haven’t reviewed the vagina/vulva. Because of this I performed the data review in multiple steps:</p>
<ol type="1">
<li>Search “vagina” in the IA eBooks and Texts collection, using “text contents” search option.</li>
</ol>
<ul>
<li>I later select “English” as the language to avoid non-English texts.</li>
</ul>
<ol start="2" type="1">
<li>Webscrape titles and years of publication from the results.</li>
<li>Filter titles of interest.</li>
<li>Use internetarchive package in conjunction with webscraping to download PDF files.</li>
</ol>
<p>I found that most of the texts I could download were from pre-1970. I requested titles retrieved from my IA search through the UMass library or through an inter-library loan, which were primarily PDFs like the IA data. I then processed both datasets:</p>
<ol type="1">
<li>Remove headers/footer chapter titles</li>
<li>Edit image backgrounds and transparency for OCR</li>
<li>Use Tesseract to OCR</li>
</ol>
</section>
<section id="internet-archive-data-retrieval" class="level1">
<h1>Internet Archive Data Retrieval</h1>
<section id="part-1-and-2-webscraping-titles-from-the-ia-website" class="level3">
<h3 class="anchored" data-anchor-id="part-1-and-2-webscraping-titles-from-the-ia-website">Part 1 and 2: Webscraping Titles from the IA Website</h3>
<p>I performed the search explained in step 1 above. As a note, when I tried to use “AND” to include both “penis” and “vagina”, but when I flipped the order, a different number of results appeared. I confirmed with the IA API search manual I used the correct syntax. Because of this, I left the search-word at “vagina” since many texts historically don’t include vaginal anatomy but will include penis’.</p>
<p>In order to confirm that I can webscrape, I use the package “bow” to check the website url. It says that I need a 5 minute delay.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bow</span>(<span class="st">"https://archive.org/details/texts?query=vagina"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;polite session&gt; https://archive.org/details/texts?query=vagina
    User-agent: polite R package
    robots.txt: 2 rules are defined for 1 bots
   Crawl delay: 5 sec
  The path is scrapable for this user-agent</code></pre>
</div>
</div>
<p>The webpage has 2 options. There is infinite scrolling, but there is also a webscraping-friendly option which is with pages. I checked that the last page number is 133, so I make a set of urls to webscrape with through all these pages.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#i found out that the max page number is 133, and starts at page 0</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>urls<span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://archive.org/details/texts?query=vagina&amp;sin=TXT&amp;and[]=languageSorter%3A%22English%22&amp;page="</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>              <span class="dv">0</span><span class="sc">:</span><span class="dv">133</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>urls <span class="sc">%&gt;%</span> head</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "https://archive.org/details/texts?query=vagina&amp;sin=TXT&amp;and[]=languageSorter%3A%22English%22&amp;page=0"
[2] "https://archive.org/details/texts?query=vagina&amp;sin=TXT&amp;and[]=languageSorter%3A%22English%22&amp;page=1"
[3] "https://archive.org/details/texts?query=vagina&amp;sin=TXT&amp;and[]=languageSorter%3A%22English%22&amp;page=2"
[4] "https://archive.org/details/texts?query=vagina&amp;sin=TXT&amp;and[]=languageSorter%3A%22English%22&amp;page=3"
[5] "https://archive.org/details/texts?query=vagina&amp;sin=TXT&amp;and[]=languageSorter%3A%22English%22&amp;page=4"
[6] "https://archive.org/details/texts?query=vagina&amp;sin=TXT&amp;and[]=languageSorter%3A%22English%22&amp;page=5"</code></pre>
</div>
</div>
<p>I want to retrieve the title of each result as well as the hyperlink to its page. I next practiced scraping from one webpage. Once I confirmed that the code worked, I put it into a function. This allows me to iteratively scrape pages using map_dfr(). I make sure to include a 5 second wait period after each page is webscraped. After map scrapes all the pages, the function outputs all the results into a dataframe (which is the dfr option) so I can begin manipulating them without much more pre-processing.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#make a function that does all the work for me</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>get_titles_dates<span class="ot">&lt;-</span><span class="cf">function</span>(aurl){</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  page<span class="ot">&lt;-</span> <span class="fu">read_html</span>(aurl)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#scrape titles </span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  titles<span class="ot">&lt;-</span> page <span class="sc">%&gt;%</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_elements</span>(., <span class="at">xpath=</span><span class="st">"//div[contains(concat(' ',normalize-space(@class),' '),' item-ttl C C2 ')]/a"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"title"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  hrefs<span class="ot">&lt;-</span> page <span class="sc">%&gt;%</span> </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_elements</span>(., <span class="at">xpath=</span><span class="st">"//div[contains(concat(' ',normalize-space(@class),' '),' item-ttl C C2 ')]/a"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"href"</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#combine</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  tempdat<span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(<span class="at">titles =</span> titles, </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hrefs =</span> hrefs)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tempdat)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># iteratively scrape urls and return as a dataframe</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">map_dfr</span>(urls, <span class="sc">~</span>{</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({<span class="fu">get_titles_dates</span>(.x)},</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">error =</span> <span class="cf">function</span>(e){</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>             <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, .x, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>) <span class="co">#report bad urls -- used for testing</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>           })</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="do">##save data in case it crashes</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co"># save(dat, file = "/Users/emmanuelmiller/Desktop/dacss697d/forblog/Text_as_Data_Fall_2022/posts/_data/hrefs.RData")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> head</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  titles                                                                   hrefs
  &lt;chr&gt;                                                                    &lt;chr&gt;
1 A NEW HYGROMIIDAE FROM THE ITALIAN APENNINES AND NOTES ON THE GENUS CER… /det…
2 Operative gynecology                                                     /det…
3 Pathology of the uterine cervix, vagina, and vulva                       /det…
4 Diseases of women: a manual of gynecology designed especially for the u… /det…
5 A treatise on gynaecology, clinical and operative                        /det…
6 The Principles and practice of gynecology : for students and practition… /det…</code></pre>
</div>
</div>
</section>
<section id="part-3-clean-and-select-titles-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="part-3-clean-and-select-titles-of-interest">Part 3: Clean and Select Titles of Interest</h3>
<p>I first need to clean the webscraped titles so I can identify duplicate uploads. This is because multiple users can upload the same book and all results are included in my search. I’ll remove duplicates a bit further down.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#clean titles</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>dat2<span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">original_titles =</span> titles,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">titles =</span> <span class="fu">trimws</span>(titles, <span class="at">which =</span> <span class="st">"both"</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">titles =</span> <span class="fu">tolower</span>(titles),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">titles =</span> <span class="fu">str_replace_all</span>(titles, <span class="fu">c</span>(<span class="st">"[[:punct:]]|electronic resource"</span> <span class="ot">=</span> <span class="st">" "</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"æ"</span> <span class="ot">=</span> <span class="st">"ae"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"</span><span class="sc">\\</span><span class="st">bvol</span><span class="sc">\\</span><span class="st">w*"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"microform"</span> <span class="ot">=</span> <span class="st">""</span>, </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span> <span class="ot">=</span> <span class="st">" "</span>)), <span class="co">#theres extra punct at ends</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">titles =</span> <span class="fu">trimws</span>(titles, <span class="at">which =</span> <span class="st">"both"</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">."</span>)) <span class="sc">%&gt;%</span> <span class="co">#get rid of the extra row that map gives us</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  unique</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>dat2 <span class="sc">%&gt;%</span> head</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  titles                                                           hrefs origi…¹
  &lt;chr&gt;                                                            &lt;chr&gt; &lt;chr&gt;  
1 a new hygromiidae from the italian apennines and notes on the g… /det… A NEW …
2 operative gynecology                                             /det… Operat…
3 pathology of the uterine cervix vagina and vulva                 /det… Pathol…
4 diseases of women a manual of gynecology designed especially fo… /det… Diseas…
5 a treatise on gynaecology clinical and operative                 /det… A trea…
6 the principles and practice of gynecology for students and prac… /det… The Pr…
# … with abbreviated variable name ¹​original_titles</code></pre>
</div>
</div>
<p>I remove titles, following what I have described primarily in blog post 1 about my text selection criteria. Here I will go into further detail:</p>
<ul>
<li>The text sources we are looking at are books, so sources such as “essays”, “journals”, “encyclopedias”, “ICD manuals”, “studies”, catalogs”, “experiments”, “doctrines”, “translations” or “memoirs” are excluded.
<ul>
<li>Others that fit in this category include books describing “key facts” or a topic, or “idiot’s guides” that are also for the general public.</li>
<li>Books that were primarily illustrations or coloring</li>
</ul></li>
<li>Texts that aren’t books but rather journals. This includes “Current Operative Urology”, “papers”, a report on a double uterus, and “Surgical Clinics of North America”</li>
<li>Excluding books specific to pathology or disease. Other studies have also excluded pathological conditions in their reviews of textbooks (Andrikopoulou et al., 2013; Hayes &amp; Temple-Smith, 2021). The ways in which disease are described depending on genitals beyond the scope of this pilot study.
<ul>
<li>Other synonyms visible in books include “morbid”, “cancer”, “treatment”, “gravid uterus”, and “disorder”.</li>
</ul></li>
<li>Excluding pediatric and adolescent gynecology books, and those specific to midwifery.</li>
<li>Other books related to animals, marriage, sociology, philosophy weren’t included.</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>dat3<span class="ot">&lt;-</span> dat2 <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"essay|journ|memoi|ency|icd|cata|studies|experim"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"trans|doctrin|repor|iss|malign|notes|review"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"current operative urology|papers|double uterus|dysfunction"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"key|idiot|illustrated anatomy|colou*r|crash|treatis|cookbook"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(titles, <span class="st">"anatomy|anatomical|urolog|clinic|surgical clinics of north america"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"patho|disea|morbid|canc|treatm|gravid|midwif"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"restora|pedia|adolescen|private parts"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"marr|achatinidae|cleistogamia|elephant|cow|cestoidea"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"myrmecophaga|snail|equine|omphalina|neniinae|philosoph"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"ariolimax|gaseopoa|horse|sociology|psycho|ants"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"sex|dog|anatomie des menschen|albolabris|disor"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="part-4-downloading-data-and-making-metadata" class="level3">
<h3 class="anchored" data-anchor-id="part-4-downloading-data-and-making-metadata">Part 4: Downloading Data and Making Metadata</h3>
<p>In order to retrieve information on the publication date of each title, I use the internetarchive package. The hyperlink extracted earlier has the identifier that I can use to retrieve information. I found that the internetarchive ‘ia_search()’ function doesn’t return as accurate information just looking up the name of the book. Searching using the identifier of the book only didn’t work for one book. I looked it up on the website and I couldn’t download the book anyway because of the copyright.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dat4<span class="ot">&lt;-</span> dat3 <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hrefs =</span> <span class="fu">str_extract</span>(hrefs, <span class="st">"(?&lt;=details/).*(?=</span><span class="sc">\\</span><span class="st">?q=vagina)"</span>),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">hrefs =</span> <span class="fu">str_replace_all</span>(hrefs, <span class="fu">c</span>(<span class="st">"/.*"</span> <span class="ot">=</span> <span class="st">""</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dates =</span> <span class="fu">map</span>(hrefs, <span class="sc">~</span><span class="fu">ia_search</span>(<span class="fu">c</span>(<span class="st">"identifier"</span> <span class="ot">=</span> .)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                       ia_get_items <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                       ia_metadata))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>dat5<span class="ot">&lt;-</span> dat4 <span class="sc">%&gt;%</span> </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hmm =</span> <span class="fu">map</span>(dates, <span class="sc">~</span><span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(hmm) <span class="sc">%&gt;%</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(hmm<span class="sc">!=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I also retrieved information as to the confidence level of the OCR. If there is a confidence level reported, I select a cutoff of &gt;85%. I also select books with a date reported which is greater than 1875.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#reshape data</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>dat5<span class="ot">&lt;-</span> dat5 <span class="sc">%&gt;%</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dates =</span> <span class="fu">map</span>(dates, . <span class="sc">%&gt;%</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">filter</span>(field <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"ocr_detected_script_conf"</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(dates) <span class="sc">%&gt;%</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> field, <span class="at">values_from =</span> value ) </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">#clean dates</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>dat6<span class="ot">&lt;-</span> dat5 <span class="sc">%&gt;%</span> </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">dates =</span> date) <span class="sc">%&gt;%</span> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dates =</span> <span class="fu">case_when</span>(</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    dates <span class="sc">==</span> <span class="st">"[n.d.]"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(dates)<span class="sc">~</span> <span class="fu">str_extract</span>(dates, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>),</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    T<span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dates =</span> <span class="fu">as.numeric</span>(dates))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">#filter</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>dat6<span class="ot">&lt;-</span> dat6 <span class="sc">%&gt;%</span> </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ocr_detected_script_conf <span class="sc">&gt;</span> <span class="fl">0.85</span> <span class="sc">|</span> <span class="fu">is.na</span>(ocr_detected_script_conf)) <span class="sc">%&gt;%</span> </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ocr_detected_script_conf) <span class="sc">%&gt;%</span> </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dates <span class="sc">&gt;</span> <span class="dv">1875</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(dates))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dat7 <span class="sc">%&gt;%</span> <span class="fu">select</span>(titles, dates, hrefs) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  titles                                                             dates hrefs
  &lt;chr&gt;                                                              &lt;dbl&gt; &lt;chr&gt;
1 researches in female pelvic anatomy                                 1892 rese…
2 atlas of pelvic anatomy and gynecologic surgery                     2001 atla…
3 clinical gynaecology medical and surgical                           1895 clin…
4 contraception healthy choices a contraceptive clinic in a book      2009 cont…
5 textbook of female urology and urogynaecology                       2001 text…
6 the anatomy and physiology of obstetrics a short textbook for stu…  1969 anat…</code></pre>
</div>
</div>
<p>I was originally going to use the internetarchive package to download the text versions of these books. I found that in some cases, I was not able to download some of the books because they contained “due to issues with the item’s content” (according to the file that I did receive). When I looked the book up on the IA website, I could access a text version of the book. I webscraped versions of these books but they didn’t have delimiters between different pages, which meant that I couldn’t reasonably remove headers and footers like the PDF files that I retrieved from the library. I was concerned about the quality of the data for this reason. After review of the IA website, I found out that I could download PDF versions of many of these books. I also found out that the UMass Library had Adobe Acrobat editor. I decided that because this dataset is relatively small I would spend an afternoon editing these PDFs to have better data.</p>
<p>I examined the url structure on the IA website for downloading PDFs. I used the previously-webscraped hyperlink to construct the url I would download PDFs from.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dat7<span class="ot">&lt;-</span> dat6 <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(titles, dates, hrefs) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"https://archive.org/download/"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                      hrefs, <span class="st">"/"</span>, hrefs, <span class="st">".pdf"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I then used download.file() to download iteratively the urls I constructed. This returned for me 68 PDFs. This is approximately the same number of results as webscraping.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"/Users/emmanuelmiller/Desktop/dacss697d/forblog/Text_as_Data_Fall_2022/posts/download_pdfs"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>temp<span class="ot">&lt;-</span> dat7<span class="sc">$</span>url</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (url <span class="cf">in</span> temp){ </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">download.file</span>(url, <span class="at">destfile =</span> <span class="fu">basename</span>(url), <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e){</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, url, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I reviewed these PDFs to confirm that there were no duplicates and all files could be downloaded. I found that a number were in fact duplicates or did not fit the inclusion criteria (such as being journal articles). There were a total of 44 documents remaining.</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Joining, by = "files"</code></pre>
</div>
</div>
<p>Below is the distribution of dates of the IA texts. The majority of the books in the dataset are before the 1930s, which makes sense because copyrights expire within this time frame. The lack of titles in 2000s could greatly skew the sample for downstream analysis. I continue with data retrieval from the books I requested through inter-library loan in the same way I do for that of the IA texts in the next sections.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>temp<span class="ot">&lt;-</span> dat8 <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(files, dates) <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  unique <span class="sc">%&gt;%</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">after1970 =</span> <span class="fu">ifelse</span>(dates <span class="sc">&gt;</span> <span class="dv">1970</span>, <span class="st">"after"</span>, <span class="st">"before"</span>))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>ia_hist<span class="ot">&lt;-</span><span class="fu">ggplot</span>(temp, <span class="fu">aes</span>(<span class="at">x =</span> dates, <span class="at">fill =</span> after1970))<span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># save(ia_hist, file = "/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/ia_hist.RData")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ia_hist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="EmilyMiller_blogpost-2_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="ocr-text-data-acquisition" class="level1">
<h1>OCR Text Data Acquisition</h1>
<section id="part-1-pdf-header-and-footer-removal" class="level3">
<h3 class="anchored" data-anchor-id="part-1-pdf-header-and-footer-removal">Part 1: PDF Header and Footer Removal</h3>
<p>I considered a number of options for removing headers/footers. I first tried online tools but they had paywalls. I considered command-line tools like GhostScript, PDFEdit, and Poppler. Unfortunately, the text in the PDFs were not centered consistently so I would have to use a program with a GUI functionality to manually find the edges of the text body. I tried using Fiji (A.k.a. ImageJ) which is a Java-based software used by scientists to edit and analyze images. The perk of this software is that you can edit stacks of images and review them rapidly. Unfortunately, my computer didn’t have enough RAM to review at an efficient speed PDFs that were greater than 500 pages with the GUI utility. I considered partitioning these PDFs, but then I learned that UMass has a paid (but free to students) subscription to Adobe Acrobat DC which is made to edit all sorts of PDF files. This software has a functionality that automatically removes headers and footers from PDFs, but this functionality didn’t work with my data. I assumed that if AI couldn’t detect the headers/footers then it would be easier to take care of this manually using this software by cropping the documents.</p>
<p>Using Adobe Acrobat DC, I removed headers and footers. There were some pages at the end of books that advertised other books or scientific papers. I removed these pages as well. After removing the headers/footers, I exported these to PNGs of 300 DPI, as the OCR software that I am using requires this format. Using higher DPI resulted in much slower exporting and used a lot of storage on my computer.</p>
</section>
<section id="part-2-preprocessing-for-ocr" class="level3">
<h3 class="anchored" data-anchor-id="part-2-preprocessing-for-ocr">Part 2: Preprocessing for OCR</h3>
<p>To OCR, I considered two programs. I considered using Adobe Acrobat’s built-in OCR functionality which has been used in the literature (related to medical records: Hsu et al., 2022; Nguyen et al., 2020, etc). I also considered the ocr() function from the Tesseract package, a widely used (specific to medical text OCR: Goodrum et al., 2020; Hsu et al., 2022; Liu et al., 2020; Rasmussen et al., 2011; and many more), free, OCR program. Both are used in the literature, but I was more partial to Tesseract because it is more frequently used in the extraction of medical text data. In a larger study, it would be interesting to compare the quality of the OCR of both softwares. I also liked that the Tesseract command-line software would allow me to play with OCR parameters manually unlike Adobe. I decided on use of the Tesseract package as I wanted more control over the OCR conditions and its frequent use in the literature.</p>
<p>The Tesseract vignette recommends a number of procedures for altering images that increase the quality of the OCR. This includes deskewing text, trimming whitespace, removing noise and artifacts, converting images to black and white (binarization), and changing the thickness of the characters (dilation/erosion). All my images were above 10px so I didn’t have to resize them. Historical data is notoriously difficult to OCR. Many of my documents are in a serif font, which is problematic because the middle of letters is typically much thinner.</p>
<p>I tried using 2 different programs, Magick and ImageJ2. I didn’t use Magick (which is in R) because the software wasn’t effective at removing background effects. Using ImageJ2 (v 2.9.0) I did the above preprocessing. To deskew, I used the following code and saved it in plugins/Analyze folder. I took the code from <a href="https://forum.image.sc/t/get-direction-from-directionality-using-an-ij1-macro/11550/6">this user</a>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#@ ImagePlus imp</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#@ ResultsTable rt</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>import fiji.analyze.directionality.Directionality_</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>d <span class="ot">=</span> new <span class="fu">Directionality_</span>()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">d.setImagePlus</span>(imp)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">d.setMethod</span>(Directionality_.AnalysisMethod.LOCAL_GRADIENT_ORIENTATION)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="fu">d.computeHistograms</span>()</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="fu">d.fitHistograms</span>()</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">d.getFitAnalysis</span>()</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>mainDirection <span class="ot">=</span> <span class="fu">Math.toDegrees</span>(result[<span class="dv">0</span>][<span class="dv">0</span>])</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rt.incrementCounter</span>()</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="fu">rt.addValue</span>(<span class="st">"Main Direction"</span>, mainDirection)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="fu">rt.show</span>(<span class="st">"Results"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I ran the following ImageJ2 macro on my dataset. This script took several hours to run because image processing is a computationally heavy task. In addition to this, I selected time images and used the “erode” feature.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>input <span class="ot">=</span> <span class="st">"/Volumes/em_2022/good_pngs/"</span>;</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>output <span class="ot">=</span> <span class="st">"/Volumes/em_2022/good_tiffs/"</span>;</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>fileList <span class="ot">=</span> <span class="fu">getFileList</span>(input);</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span> <span class="fu">action</span>(input, output, filename) {</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">open</span>(input <span class="sc">+</span> filename);</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">/</span><span class="er">/</span>clean up</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">run</span>(<span class="st">"Sharpen"</span>);</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Despeckle"</span>);</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Gaussian Blur..."</span>, <span class="st">"sigma=1"</span>);</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>      <span class="sc">/</span><span class="er">/</span>make binary</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Sharpen"</span>);</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Find Maxima..."</span>, <span class="st">"prominence=10 exclude light output=Count"</span>);</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        x <span class="ot">=</span> <span class="fu">getResult</span>(<span class="st">"Count"</span>, <span class="dv">0</span>);</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (x <span class="sc">&gt;</span> <span class="dv">50</span>){</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>          <span class="sc">/</span><span class="er">/</span><span class="cf">for</span> the black and white images that have the black box</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (bitDepth<span class="sc">!=</span><span class="dv">24</span>) {</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">run</span>(<span class="st">"Find Maxima..."</span>, <span class="st">"prominence=10 exclude light output=[Point Selection]"</span>);</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>              <span class="fu">run</span>(<span class="st">"Fit Rectangle"</span>);</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>              <span class="fu">run</span>(<span class="st">"Enlarge..."</span>, <span class="st">"enlarge=60"</span>);</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>              <span class="fu">run</span>(<span class="st">"Crop"</span>);</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>          <span class="fu">run</span>(<span class="st">"Subtract Background..."</span>, <span class="st">"rolling=100 light"</span>);</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>          <span class="fu">run</span>(<span class="st">"Sharpen"</span>);</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">run</span>(<span class="st">"Smooth"</span>);</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Convert to Mask"</span>);</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>      <span class="sc">/</span><span class="er">/</span>crop</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Select Bounding Box"</span>);</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Enlarge..."</span>, <span class="st">"enlarge=50"</span>);</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Crop"</span>);</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>      <span class="sc">/</span><span class="er">/</span>transform</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (x <span class="sc">&gt;</span> <span class="dv">50</span>){</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">selectWindow</span>(filename);</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Select Bounding Box"</span>);</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Copy"</span>);</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Create Mask"</span>);</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        title_mask <span class="ot">=</span> <span class="fu">getTitle</span>();</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">selectWindow</span>(title_mask);</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Paste"</span>);</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Gaussian Blur..."</span>, <span class="st">"sigma=30"</span>);</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Enhance Contrast..."</span>, <span class="st">"saturated=0.1"</span>);</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Clear Results"</span>);</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Get Main Direction"</span>, <span class="st">"rt=[title=Results, size=1, hdr= </span><span class="sc">\t</span><span class="st">Main Direction]"</span>);</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>        angle <span class="ot">=</span> <span class="fu">getResult</span>(<span class="st">"Main Direction"</span>, <span class="dv">0</span>);</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>        angle <span class="ot">=</span> angle <span class="sc">*</span> <span class="sc">-</span><span class="fl">1.0</span>;</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">abs</span>(angle) <span class="sc">&lt;</span> <span class="dv">30</span>){</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>          <span class="fu">selectWindow</span>(filename);</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Rotate... "</span>, <span class="st">"angle="</span><span class="sc">+</span> angle<span class="sc">+</span>  <span class="st">" grid=1 interpolation=Bilinear fill"</span>);</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>        }   </span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">selectWindow</span>(title_mask);</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">close</span>();</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>      <span class="sc">/</span><span class="er">/</span>remove results window</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">selectWindow</span>(<span class="st">"Results"</span>); </span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Clear Results"</span>);</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Close"</span>);</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">saveAs</span>(<span class="st">"Tiff"</span>, output <span class="sc">+</span> filename);</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">close</span>();</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="at">i =</span> <span class="dv">0</span>; i <span class="sc">&lt;</span> fileList.length; i<span class="sc">++</span>){</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">action</span>(input, output, fileList[i]);      </span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Below is an example of the clean image.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>magick<span class="sc">::</span><span class="fu">image_read</span>(<span class="st">"posts/_data/edited_b2041349x_001_Page_047.png"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  print</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<pre><code>Error in magick_image_readpath(path, density, depth, strip, defines): R: UnableToOpenBlob `posts/_data/edited_b2041349x_001_Page_047.png': No such file or directory @ error/blob.c/OpenBlob/2924</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>magick<span class="sc">::</span><span class="fu">image_read</span>(<span class="st">"posts/_data/1edited_b2041349x_001_Page_047.tif"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  magick<span class="sc">::</span><span class="fu">image_background</span>(<span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  print</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<pre><code>Error in magick_image_readpath(path, density, depth, strip, defines): R: UnableToOpenBlob `posts/_data/1edited_b2041349x_001_Page_047.tif': No such file or directory @ error/blob.c/OpenBlob/2924</code></pre>
</div>
</div>
</section>
<section id="part3-tesseract-ocr" class="level3">
<h3 class="anchored" data-anchor-id="part3-tesseract-ocr">Part3: Tesseract OCR</h3>
<p>It is possible to provide Tesseract with an updated dictionary as well as pages to OCR in its database. Users have to re-render the model after doing this. I tried to add just to the dictionary (using vocabulary I made which I will describe in my next blog post). Unfortunately, my computer crashed. Given greater computational resources, this would be an avenue to follow to improve the accuracy of the OCR. For the purposes of this pilot study, I instead used the following loop to save text to a separate file.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"/Users/emmanuelmiller/Desktop/text_ia"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>temp<span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">files =</span> <span class="fu">list.files</span>())</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#ocr and save to files</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(temp)){</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  filename <span class="ot">&lt;-</span> temp<span class="sc">$</span>files[i]</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> tesseract<span class="sc">::</span><span class="fu">ocr</span>(filename)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(dat, <span class="at">file =</span> <span class="fu">file</span>(<span class="fu">paste0</span>(<span class="fu">basename</span>(filename), <span class="st">".txt"</span>)), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Below is an example of some of the raw OCR data. I will demonstrate how I clean it in the next blog post.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>book_peek<span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">files =</span> <span class="fu">list.files</span>(<span class="st">"/Users/emmanuelmiller/Desktop/text_ia/"</span>,</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">full.names =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">40</span><span class="sc">:</span><span class="dv">50</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dat =</span> <span class="fu">map</span>(files, <span class="sc">~</span><span class="fu">str_c</span>(<span class="fu">read_lines</span>(.), <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">dat =</span> <span class="fu">str_sub</span>(dat, <span class="dv">0</span>, <span class="dv">250</span>),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">url =</span> <span class="fu">str_extract</span>(files, <span class="st">"(?&lt;=edit</span><span class="sc">\\</span><span class="st">w{0,3}_).*(?=_Page)"</span>),</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">page =</span> <span class="fu">str_extract</span>(files, <span class="st">"(?&lt;=Page_)</span><span class="sc">\\</span><span class="st">d+"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(url, page, dat) <span class="sc">%&gt;%</span> </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  kable <span class="sc">%&gt;%</span> </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co"># save(book_peek, file = "/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/book_peek.RData")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>book_peek</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> url </th>
   <th style="text-align:left;"> page </th>
   <th style="text-align:left;"> dat </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 040 </td>
   <td style="text-align:left;"> A’. The peroneal artery, a branch of the posterior tibial,
descends vertically along the posterior aspect of the fibula as far
as the lower tibio-fibular articulation, being covered above by the
soleus, then lying between the flexor longus pollicis a </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 041 </td>
   <td style="text-align:left;"> If. LicaTtuRE oF THE UpreR Part or THE ANTERIOR TIBIAL
ARTERY.

(1). At rather more than an inch external to the crest of the
tibia, and in the course of a line which would extend from the
head of the fibula to the'centre of the) ankle joint make an </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 042 </td>
   <td style="text-align:left;"> PLATE XIV.
LIGATURE OF THE POSTERIOR TIBIAL ARTERY.
Fig. 1.—ANaTomy.

1. The patella. 2. Internal malleolus. 3. Internal surface
of the tibia. 4. Internal aponeurosis. 5. Soleus muscle drawn
backwards.

A. The posterior tibial artery commencing at th </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 043 </td>
   <td style="text-align:left;"> @
d, the common flexor ; ¢, the posterior tibial nerve; A, the
artery.
Incision No. 3.—Ligature of the upper third of the posterior tibial
artery.

a, The skin ; 6, the aponeurosis ; c, the gastrocnemius drawn
back by a retractor; d, an incision made </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 044 </td>
   <td style="text-align:left;"> (4). Whilst these muscles are held backwards and outwards .
by a retractor, divide upon a director the deep aponeurotic fascia,
beneath which can be seen the vessels. (

(5). Isolate the artery, and pass the ligature with either a
Cooper’s or a Desch </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 045 </td>
   <td style="text-align:left;"> PLATE XV.
LIGATURE OF THE POPLITEAL ARTERY.
Figs. 1, 2, and 3.—ANaToMY.

Fig. 1.—Aponeurotic layer, superficial cessels and nerves. .

1—1. Popliteal aponeurosis in part removed. 2. Semi-
membranosus. 3. Biceps. 4. Cutaneous vessels and nerves.
5. In </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 046 </td>
   <td style="text-align:left;"> lower part of the artery is somewhat internal and at the upper
part external to the artery. These two vessels are covered
superiorly by the belly of the semi-membranosus (1), and at
the lower part by the two bellies of the gastrocnemius (2 and 3).
Th </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 047 </td>
   <td style="text-align:left;"> (4). Recognize the outer border of the semimembranosus
muscle, and the popliteal nerve will be now seen coming from
beneath it.

(5). Push the nerve inwards, and beneath and a little internal
to it will be found the popliteal vein.

(6). Isolate the </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 048 </td>
   <td style="text-align:left;"> PLATE XVI.
LIGATURE OF THE FEMORAL ARTERY.
Fig. 1.—ANaTOMY.

A. The femoral artery, a continuation of the external iliac,
extends from the middle of the crural arch (1) to the end of
Hunter's canal, where it becomes the popliteal. The vessel is
in fr </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 049 </td>
   <td style="text-align:left;"> d, internal saphenous nerve ; ¢, tendinous sheath of the femoral

veasels at Hunter's canal ; A, the artery.

Incision No. 2.—Ligature of , the femoral artery im its upper
ird,

@, the skin and cellular tissue; 6, aponeurosis; c, sheath
of the femora </td>
  </tr>
  <tr>
   <td style="text-align:left;"> atextbookoperat00huetgoog </td>
   <td style="text-align:left;"> 050 </td>
   <td style="text-align:left;"> which unites the vessels together, and pass the ligature from
bebind forwards.

Ligature of the femoral artery in the middle of the thigh.

HUNTER’S OPERATION.
Fig. 2, Incision 2.

The limb being placed as in the preceding operation—

(1). Make an in </td>
  </tr>
</tbody>
</table>

</div>
</div>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<p>Goodrum H, Roberts K, Bernstam EV. Automatic classification of scanned electronic health record documents. Int J Med Inform. 2020 Dec;144:104302. doi: 10.1016/j.ijmedinf.2020.104302. Epub 2020 Oct 17. PMID: 33091829; PMCID: PMC7731898. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7731898/</p>
<p>Hsu E, Malagaris I, Kuo YF, Sultana R, Roberts K. Deep learning-based NLP data pipeline for EHR-scanned document information extraction. JAMIA Open. 2022 Jun 11;5(2):ooac045. doi: 10.1093/jamiaopen/ooac045. PMID: 35702624; PMCID: PMC9188320. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9188320/</p>
<p>Liu X, Meehan J, Tong W, Wu L, Xu X, Xu J. DLI-IT: a deep learning approach to drug label identification through image and text embedding. BMC Med Inform Decis Mak. 2020 Apr 15;20(1):68. doi: 10.1186/s12911-020-1078-3. PMID: 32293428; PMCID: PMC7158001. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7158001/</p>
<p>Nguyen, A., O’Dwyer, J., Vu, T., Webb, P. M., Johnatty, S. E., &amp; Spurdle, A. B. (2020). Generating high-quality data abstractions from scanned clinical records: text-mining-assisted extraction of endometrial carcinoma pathology features as proof of principle. BMJ open, 10(6), e037740. https://doi.org/10.1136/bmjopen-2020-037740 https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7295399/</p>
<p>Rasmussen LV, Peissig PL, McCarty CA, Starren J. Development of an optical character recognition pipeline for handwritten form fields from an electronic health record. J Am Med Inform Assoc. 2012 Jun;19(e1):e90-5. doi: 10.1136/amiajnl-2011-000182. Epub 2011 Sep 2. PMID: 21890871; PMCID: PMC3392858.https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3392858/</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="DACSS/Text_as_Data_Fall_2022" data-repo-id="R_kgDOH5675w" data-category="Announcements" data-category-id="" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Blog Post 2: Medical Textbook Acquisition"</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Emily Miller"</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="an">desription:</span><span class="co"> "Downloading medical textbooks through webscraping and OCR"</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "10/02/2022"</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">  - hw2</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - blogpost2</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">  - Emily Miller</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - internetarchivebooks</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - internetarchive</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co">  - tidyverse</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co">  - polite</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co">  - rvest</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co">  - tesseract</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include = F}</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) </span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(polite)</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringi)</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hunspell)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/hrefs.RData"</span>)</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/dat7.RData"</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/ia_hist.RData"</span>)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/book_peek.RData"</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="co">#load this here so I don't have to rerun everything</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="co"># dat &lt;- readr::read_csv("_data/out.csv")</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a><span class="co"># load("dat9.RData")</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a><span class="fu"># Recap</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>**Questions:**</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Is there a difference in language use between penises and vulvas?</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Is there a change in language use over time?</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>**How:** Compare language use in anatomy textbooks</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a><span class="fu"># Overview</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>Acquiring textbooks from the Internet Archive (IA) took me multiple steps. On the IA website, there is an option to search through the text portion of a book. On the IA API, however, I couldn't find this option. The best I could find was looking through a book's metadata, which wasn't the same. When I looked for the word "vagina", this returned gynecology books and almost no anatomy books, compared to when I searched in the text. I decided to search "vagina" instead of "genital" because some anatomy books historically haven't reviewed the vagina/vulva. Because of this I performed the data review in multiple steps:</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Search "vagina" in the IA eBooks and Texts collection, using "text contents" search option.</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>I later select "English" as the language to avoid non-English texts.</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Webscrape titles and years of publication from the results.</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Filter titles of interest.</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Use internetarchive package in conjunction with webscraping to download PDF files.</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>I found that most of the texts I could download were from pre-1970. I requested titles retrieved from my IA search through the UMass library or through an inter-library loan, which were primarily PDFs like the IA data. I then processed both datasets:</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Remove headers/footer chapter titles</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Edit image backgrounds and transparency for OCR</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Use Tesseract to OCR</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a><span class="fu"># Internet Archive Data Retrieval</span></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 1 and 2: Webscraping Titles from the IA Website</span></span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>I performed the search explained in step 1 above. As a note, when I tried to use "AND" to include both "penis" and "vagina", but when I flipped the order, a different number of results appeared. I confirmed with the IA API search manual I used the correct syntax. Because of this, I left the search-word at "vagina" since many texts historically don't include vaginal anatomy but will include penis'.</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>In order to confirm that I can webscrape, I use the package "bow" to check the website url. It says that I need a 5 minute delay.</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a><span class="fu">bow</span>(<span class="st">"https://archive.org/details/texts?query=vagina"</span>)</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>The webpage has 2 options. There is infinite scrolling, but there is also a webscraping-friendly option which is with pages. I checked that the last page number is 133, so I make a set of urls to webscrape with through all these pages.</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a><span class="co">#i found out that the max page number is 133, and starts at page 0</span></span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>urls<span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://archive.org/details/texts?query=vagina&amp;sin=TXT&amp;and[]=languageSorter%3A%22English%22&amp;page="</span>,</span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>              <span class="dv">0</span><span class="sc">:</span><span class="dv">133</span>)</span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>urls <span class="sc">%&gt;%</span> head</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>I want to retrieve the title of each result as well as the hyperlink to its page. I next practiced scraping from one webpage. Once I confirmed that the code worked, I put it into a function. This allows me to iteratively scrape pages using map_dfr(). I make sure to include a 5 second wait period after each page is webscraped. After map scrapes all the pages, the function outputs all the results into a dataframe (which is the dfr option) so I can begin manipulating them without much more pre-processing.</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a><span class="co">#make a function that does all the work for me</span></span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>get_titles_dates<span class="ot">&lt;-</span><span class="cf">function</span>(aurl){</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a>  page<span class="ot">&lt;-</span> <span class="fu">read_html</span>(aurl)</span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>  <span class="co">#scrape titles </span></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>  titles<span class="ot">&lt;-</span> page <span class="sc">%&gt;%</span> </span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_elements</span>(., <span class="at">xpath=</span><span class="st">"//div[contains(concat(' ',normalize-space(@class),' '),' item-ttl C C2 ')]/a"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"title"</span>)</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>  hrefs<span class="ot">&lt;-</span> page <span class="sc">%&gt;%</span> </span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_elements</span>(., <span class="at">xpath=</span><span class="st">"//div[contains(concat(' ',normalize-space(@class),' '),' item-ttl C C2 ')]/a"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">html_attr</span>(<span class="st">"href"</span>)</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>  <span class="co">#combine</span></span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a>  tempdat<span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(<span class="at">titles =</span> titles, </span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hrefs =</span> hrefs)</span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tempdat)</span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a><span class="co"># iteratively scrape urls and return as a dataframe</span></span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">map_dfr</span>(urls, <span class="sc">~</span>{</span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({<span class="fu">get_titles_dates</span>(.x)},</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>           <span class="at">error =</span> <span class="cf">function</span>(e){</span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>             <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, .x, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>) <span class="co">#report bad urls -- used for testing</span></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>           })</span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a><span class="do">##save data in case it crashes</span></span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a><span class="co"># save(dat, file = "/Users/emmanuelmiller/Desktop/dacss697d/forblog/Text_as_Data_Fall_2022/posts/_data/hrefs.RData")</span></span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> head</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 3: Clean and Select Titles of Interest</span></span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a>I first need to clean the webscraped titles so I can identify duplicate uploads. This is because multiple users can upload the same book and all results are included in my search. I'll remove duplicates a bit further down.</span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a><span class="co">#clean titles</span></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>dat2<span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">original_titles =</span> titles,</span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>         <span class="at">titles =</span> <span class="fu">trimws</span>(titles, <span class="at">which =</span> <span class="st">"both"</span>),</span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>         <span class="at">titles =</span> <span class="fu">tolower</span>(titles),</span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>         <span class="at">titles =</span> <span class="fu">str_replace_all</span>(titles, <span class="fu">c</span>(<span class="st">"[[:punct:]]|electronic resource"</span> <span class="ot">=</span> <span class="st">" "</span>,</span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"æ"</span> <span class="ot">=</span> <span class="st">"ae"</span>,</span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"</span><span class="sc">\\</span><span class="st">bvol</span><span class="sc">\\</span><span class="st">w*"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"microform"</span> <span class="ot">=</span> <span class="st">""</span>, </span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">"</span><span class="sc">\\</span><span class="st">s+"</span> <span class="ot">=</span> <span class="st">" "</span>)), <span class="co">#theres extra punct at ends</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>         <span class="at">titles =</span> <span class="fu">trimws</span>(titles, <span class="at">which =</span> <span class="st">"both"</span>)</span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">."</span>)) <span class="sc">%&gt;%</span> <span class="co">#get rid of the extra row that map gives us</span></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>  unique</span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>dat2 <span class="sc">%&gt;%</span> head</span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a>I remove titles, following what I have described primarily in blog post 1 about my text selection criteria. Here I will go into further detail:</span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The text sources we are looking at are books, so sources such as "essays", "journals", "encyclopedias", "ICD manuals", "studies", catalogs", "experiments", "doctrines", "translations" or "memoirs" are excluded.</span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Others that fit in this category include books describing "key facts" or a topic, or "idiot's guides" that are also for the general public.</span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Books that were primarily illustrations or coloring</span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Texts that aren't books but rather journals. This includes "Current Operative Urology", "papers", a report on a double uterus, and "Surgical Clinics of North America"</span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Excluding books specific to pathology or disease. Other studies have also excluded pathological conditions in their reviews of textbooks (Andrikopoulou et al., 2013; Hayes &amp; Temple-Smith, 2021). The ways in which disease are described depending on genitals beyond the scope of this pilot study.</span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Other synonyms visible in books include "morbid", "cancer", "treatment", "gravid uterus", and "disorder".</span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Excluding pediatric and adolescent gynecology books, and those specific to midwifery.</span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Other books related to animals, marriage, sociology, philosophy weren't included.</span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a>dat3<span class="ot">&lt;-</span> dat2 <span class="sc">%&gt;%</span> </span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"essay|journ|memoi|ency|icd|cata|studies|experim"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"trans|doctrin|repor|iss|malign|notes|review"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"current operative urology|papers|double uterus|dysfunction"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"key|idiot|illustrated anatomy|colou*r|crash|treatis|cookbook"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(titles, <span class="st">"anatomy|anatomical|urolog|clinic|surgical clinics of north america"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"patho|disea|morbid|canc|treatm|gravid|midwif"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"restora|pedia|adolescen|private parts"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"marr|achatinidae|cleistogamia|elephant|cow|cestoidea"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"myrmecophaga|snail|equine|omphalina|neniinae|philosoph"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"ariolimax|gaseopoa|horse|sociology|psycho|ants"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(titles, <span class="st">"sex|dog|anatomie des menschen|albolabris|disor"</span>))</span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 4: Downloading Data and Making Metadata</span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a>In order to retrieve information on the publication date of each title, I use the internetarchive package. The hyperlink extracted earlier has the identifier that I can use to retrieve information. I found that the internetarchive 'ia_search()' function doesn't return as accurate information just looking up the name of the book. Searching using the identifier of the book only didn't work for one book. I looked it up on the website and I couldn't download the book anyway because of the copyright.</span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>dat4<span class="ot">&lt;-</span> dat3 <span class="sc">%&gt;%</span> </span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hrefs =</span> <span class="fu">str_extract</span>(hrefs, <span class="st">"(?&lt;=details/).*(?=</span><span class="sc">\\</span><span class="st">?q=vagina)"</span>),</span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a>         <span class="at">hrefs =</span> <span class="fu">str_replace_all</span>(hrefs, <span class="fu">c</span>(<span class="st">"/.*"</span> <span class="ot">=</span> <span class="st">""</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dates =</span> <span class="fu">map</span>(hrefs, <span class="sc">~</span><span class="fu">ia_search</span>(<span class="fu">c</span>(<span class="st">"identifier"</span> <span class="ot">=</span> .)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a>                       ia_get_items <span class="sc">%&gt;%</span> </span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a>                       ia_metadata))</span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a>dat5<span class="ot">&lt;-</span> dat4 <span class="sc">%&gt;%</span> </span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hmm =</span> <span class="fu">map</span>(dates, <span class="sc">~</span><span class="fu">nrow</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(hmm) <span class="sc">%&gt;%</span> </span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(hmm<span class="sc">!=</span><span class="dv">0</span>)</span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>I also retrieved information as to the confidence level of the OCR. If there is a confidence level reported, I select a cutoff of <span class="sc">\&gt;</span>85%. I also select books with a date reported which is greater than 1875.</span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a><span class="co">#reshape data</span></span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a>dat5<span class="ot">&lt;-</span> dat5 <span class="sc">%&gt;%</span> </span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dates =</span> <span class="fu">map</span>(dates, . <span class="sc">%&gt;%</span> </span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">filter</span>(field <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"ocr_detected_script_conf"</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(dates) <span class="sc">%&gt;%</span> </span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> field, <span class="at">values_from =</span> value ) </span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a><span class="co">#clean dates</span></span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>dat6<span class="ot">&lt;-</span> dat5 <span class="sc">%&gt;%</span> </span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">dates =</span> date) <span class="sc">%&gt;%</span> </span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dates =</span> <span class="fu">case_when</span>(</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>    dates <span class="sc">==</span> <span class="st">"[n.d.]"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>,</span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(dates)<span class="sc">~</span> <span class="fu">str_extract</span>(dates, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>),</span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>    T<span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dates =</span> <span class="fu">as.numeric</span>(dates))</span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a><span class="co">#filter</span></span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a>dat6<span class="ot">&lt;-</span> dat6 <span class="sc">%&gt;%</span> </span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ocr_detected_script_conf <span class="sc">&gt;</span> <span class="fl">0.85</span> <span class="sc">|</span> <span class="fu">is.na</span>(ocr_detected_script_conf)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ocr_detected_script_conf) <span class="sc">%&gt;%</span> </span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dates <span class="sc">&gt;</span> <span class="dv">1875</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(dates))</span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>dat7 <span class="sc">%&gt;%</span> <span class="fu">select</span>(titles, dates, hrefs) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>I was originally going to use the internetarchive package to download the text versions of these books. I found that in some cases, I was not able to download some of the books because they contained "due to issues with the item's content" (according to the file that I did receive). When I looked the book up on the IA website, I could access a text version of the book. I webscraped versions of these books but they didn't have delimiters between different pages, which meant that I couldn't reasonably remove headers and footers like the PDF files that I retrieved from the library. I was concerned about the quality of the data for this reason. After review of the IA website, I found out that I could download PDF versions of many of these books. I also found out that the UMass Library had Adobe Acrobat editor. I decided that because this dataset is relatively small I would spend an afternoon editing these PDFs to have better data.</span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a>I examined the url structure on the IA website for downloading PDFs. I used the previously-webscraped hyperlink to construct the url I would download PDFs from.</span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a>dat7<span class="ot">&lt;-</span> dat6 <span class="sc">%&gt;%</span> </span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(titles, dates, hrefs) <span class="sc">%&gt;%</span> </span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"https://archive.org/download/"</span>,</span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a>                      hrefs, <span class="st">"/"</span>, hrefs, <span class="st">".pdf"</span>))</span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a>I then used download.file() to download iteratively the urls I constructed. This returned for me 68 PDFs. This is approximately the same number of results as webscraping.</span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"/Users/emmanuelmiller/Desktop/dacss697d/forblog/Text_as_Data_Fall_2022/posts/download_pdfs"</span>)</span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a>temp<span class="ot">&lt;-</span> dat7<span class="sc">$</span>url</span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (url <span class="cf">in</span> temp){ </span>
<span id="cb31-265"><a href="#cb31-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">download.file</span>(url, <span class="at">destfile =</span> <span class="fu">basename</span>(url), <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">5</span>)</span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e){</span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, url, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a>I reviewed these PDFs to confirm that there were no duplicates and all files could be downloaded. I found that a number were in fact duplicates or did not fit the inclusion criteria (such as being journal articles). There were a total of 44 documents remaining.</span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = F}</span></span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a>temp<span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">files =</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">"/Volumes/em_2022/good_pdfs/"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(files, <span class="st">"</span><span class="sc">\\</span><span class="st">.pdf$"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(files, <span class="st">"^edite*d*_"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">in_dir =</span> <span class="st">"yes"</span>)</span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>dat8<span class="ot">&lt;-</span> dat7 <span class="sc">%&gt;%</span> </span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">files =</span> <span class="fu">basename</span>(url)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(., temp)</span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a>dat8<span class="ot">&lt;-</span> dat8 <span class="sc">%&gt;%</span></span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(in_dir)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>in_dir)</span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a>Below is the distribution of dates of the IA texts. The majority of the books in the dataset are before the 1930s, which makes sense because copyrights expire within this time frame. The lack of titles in 2000s could greatly skew the sample for downstream analysis. I continue with data retrieval from the books I requested through inter-library loan in the same way I do for that of the IA texts in the next sections.</span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a>temp<span class="ot">&lt;-</span> dat8 <span class="sc">%&gt;%</span> </span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(files, dates) <span class="sc">%&gt;%</span> </span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a>  unique <span class="sc">%&gt;%</span> </span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">after1970 =</span> <span class="fu">ifelse</span>(dates <span class="sc">&gt;</span> <span class="dv">1970</span>, <span class="st">"after"</span>, <span class="st">"before"</span>))</span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a>ia_hist<span class="ot">&lt;-</span><span class="fu">ggplot</span>(temp, <span class="fu">aes</span>(<span class="at">x =</span> dates, <span class="at">fill =</span> after1970))<span class="sc">+</span></span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a><span class="co"># save(ia_hist, file = "/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/ia_hist.RData")</span></span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a>ia_hist</span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a><span class="fu"># OCR Text Data Acquisition</span></span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 1: PDF Header and Footer Removal</span></span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a>I considered a number of options for removing headers/footers. I first tried online tools but they had paywalls. I considered command-line tools like GhostScript, PDFEdit, and Poppler. Unfortunately, the text in the PDFs were not centered consistently so I would have to use a program with a GUI functionality to manually find the edges of the text body. I tried using Fiji (A.k.a. ImageJ) which is a Java-based software used by scientists to edit and analyze images. The perk of this software is that you can edit stacks of images and review them rapidly. Unfortunately, my computer didn't have enough RAM to review at an efficient speed PDFs that were greater than 500 pages with the GUI utility. I considered partitioning these PDFs, but then I learned that UMass has a paid (but free to students) subscription to Adobe Acrobat DC which is made to edit all sorts of PDF files. This software has a functionality that automatically removes headers and footers from PDFs, but this functionality didn't work with my data. I assumed that if AI couldn't detect the headers/footers then it would be easier to take care of this manually using this software by cropping the documents.</span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a>Using Adobe Acrobat DC, I removed headers and footers. There were some pages at the end of books that advertised other books or scientific papers. I removed these pages as well. After removing the headers/footers, I exported these to PNGs of 300 DPI, as the OCR software that I am using requires this format. Using higher DPI resulted in much slower exporting and used a lot of storage on my computer.</span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 2: Preprocessing for OCR</span></span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a>To OCR, I considered two programs. I considered using Adobe Acrobat's built-in OCR functionality which has been used in the literature (related to medical records: Hsu et al., 2022; Nguyen et al., 2020, etc). I also considered the ocr() function from the Tesseract package, a widely used (specific to medical text OCR: Goodrum et al., 2020; Hsu et al., 2022; Liu et al., 2020; Rasmussen et al., 2011; and many more), free, OCR program. Both are used in the literature, but I was more partial to Tesseract because it is more frequently used in the extraction of medical text data. In a larger study, it would be interesting to compare the quality of the OCR of both softwares. I also liked that the Tesseract command-line software would allow me to play with OCR parameters manually unlike Adobe. I decided on use of the Tesseract package as I wanted more control over the OCR conditions and its frequent use in the literature.</span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a>The Tesseract vignette recommends a number of procedures for altering images that increase the quality of the OCR. This includes deskewing text, trimming whitespace, removing noise and artifacts, converting images to black and white (binarization), and changing the thickness of the characters (dilation/erosion). All my images were above 10px so I didn't have to resize them. Historical data is notoriously difficult to OCR. Many of my documents are in a serif font, which is problematic because the middle of letters is typically much thinner.</span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a>I tried using 2 different programs, Magick and ImageJ2. I didn't use Magick (which is in R) because the software wasn't effective at removing background effects. Using ImageJ2 (v 2.9.0) I did the above preprocessing. To deskew, I used the following code and saved it in plugins/Analyze folder. I took the code from <span class="co">[</span><span class="ot">this user</span><span class="co">](https://forum.image.sc/t/get-direction-from-directionality-using-an-ij1-macro/11550/6)</span>.</span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a><span class="co">#@ ImagePlus imp</span></span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a><span class="co">#@ ResultsTable rt</span></span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a>import fiji.analyze.directionality.Directionality_</span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a>d <span class="ot">=</span> new <span class="fu">Directionality_</span>()</span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a><span class="fu">d.setImagePlus</span>(imp)</span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a><span class="fu">d.setMethod</span>(Directionality_.AnalysisMethod.LOCAL_GRADIENT_ORIENTATION)</span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a><span class="fu">d.computeHistograms</span>()</span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a><span class="fu">d.fitHistograms</span>()</span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">d.getFitAnalysis</span>()</span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a>mainDirection <span class="ot">=</span> <span class="fu">Math.toDegrees</span>(result[<span class="dv">0</span>][<span class="dv">0</span>])</span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a><span class="fu">rt.incrementCounter</span>()</span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a><span class="fu">rt.addValue</span>(<span class="st">"Main Direction"</span>, mainDirection)</span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a><span class="fu">rt.show</span>(<span class="st">"Results"</span>)</span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a>I ran the following ImageJ2 macro on my dataset. This script took several hours to run because image processing is a computationally heavy task. In addition to this, I selected time images and used the "erode" feature.</span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval = F}</span></span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a>input <span class="ot">=</span> <span class="st">"/Volumes/em_2022/good_pngs/"</span>;</span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a>output <span class="ot">=</span> <span class="st">"/Volumes/em_2022/good_tiffs/"</span>;</span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a>fileList <span class="ot">=</span> <span class="fu">getFileList</span>(input);</span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span> <span class="fu">action</span>(input, output, filename) {</span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">open</span>(input <span class="sc">+</span> filename);</span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a>    <span class="sc">/</span><span class="er">/</span>clean up</span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">run</span>(<span class="st">"Sharpen"</span>);</span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Despeckle"</span>);</span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Gaussian Blur..."</span>, <span class="st">"sigma=1"</span>);</span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a>      <span class="sc">/</span><span class="er">/</span>make binary</span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Sharpen"</span>);</span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Find Maxima..."</span>, <span class="st">"prominence=10 exclude light output=Count"</span>);</span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a>        x <span class="ot">=</span> <span class="fu">getResult</span>(<span class="st">"Count"</span>, <span class="dv">0</span>);</span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (x <span class="sc">&gt;</span> <span class="dv">50</span>){</span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a>          <span class="sc">/</span><span class="er">/</span><span class="cf">for</span> the black and white images that have the black box</span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (bitDepth<span class="sc">!=</span><span class="dv">24</span>) {</span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a>            <span class="fu">run</span>(<span class="st">"Find Maxima..."</span>, <span class="st">"prominence=10 exclude light output=[Point Selection]"</span>);</span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a>              <span class="fu">run</span>(<span class="st">"Fit Rectangle"</span>);</span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a>              <span class="fu">run</span>(<span class="st">"Enlarge..."</span>, <span class="st">"enlarge=60"</span>);</span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a>              <span class="fu">run</span>(<span class="st">"Crop"</span>);</span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a>          <span class="fu">run</span>(<span class="st">"Subtract Background..."</span>, <span class="st">"rolling=100 light"</span>);</span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a>          <span class="fu">run</span>(<span class="st">"Sharpen"</span>);</span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a>          <span class="fu">run</span>(<span class="st">"Smooth"</span>);</span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Convert to Mask"</span>);</span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a>      <span class="sc">/</span><span class="er">/</span>crop</span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Select Bounding Box"</span>);</span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Enlarge..."</span>, <span class="st">"enlarge=50"</span>);</span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Crop"</span>);</span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a>      <span class="sc">/</span><span class="er">/</span>transform</span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (x <span class="sc">&gt;</span> <span class="dv">50</span>){</span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a>        <span class="fu">selectWindow</span>(filename);</span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Select Bounding Box"</span>);</span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Copy"</span>);</span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Create Mask"</span>);</span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a>        title_mask <span class="ot">=</span> <span class="fu">getTitle</span>();</span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a>        <span class="fu">selectWindow</span>(title_mask);</span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Paste"</span>);</span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Gaussian Blur..."</span>, <span class="st">"sigma=30"</span>);</span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Enhance Contrast..."</span>, <span class="st">"saturated=0.1"</span>);</span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Clear Results"</span>);</span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Get Main Direction"</span>, <span class="st">"rt=[title=Results, size=1, hdr= </span><span class="sc">\t</span><span class="st">Main Direction]"</span>);</span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a>        angle <span class="ot">=</span> <span class="fu">getResult</span>(<span class="st">"Main Direction"</span>, <span class="dv">0</span>);</span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a>        angle <span class="ot">=</span> angle <span class="sc">*</span> <span class="sc">-</span><span class="fl">1.0</span>;</span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">abs</span>(angle) <span class="sc">&lt;</span> <span class="dv">30</span>){</span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a>          <span class="fu">selectWindow</span>(filename);</span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a>        <span class="fu">run</span>(<span class="st">"Rotate... "</span>, <span class="st">"angle="</span><span class="sc">+</span> angle<span class="sc">+</span>  <span class="st">" grid=1 interpolation=Bilinear fill"</span>);</span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a>        }   </span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a>        <span class="fu">selectWindow</span>(title_mask);</span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a>        <span class="fu">close</span>();</span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a>      <span class="sc">/</span><span class="er">/</span>remove results window</span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a>      <span class="fu">selectWindow</span>(<span class="st">"Results"</span>); </span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Clear Results"</span>);</span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run</span>(<span class="st">"Close"</span>);</span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a>      <span class="fu">saveAs</span>(<span class="st">"Tiff"</span>, output <span class="sc">+</span> filename);</span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a>    <span class="fu">close</span>();</span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-423"><a href="#cb31-423" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="at">i =</span> <span class="dv">0</span>; i <span class="sc">&lt;</span> fileList.length; i<span class="sc">++</span>){</span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a>    <span class="fu">action</span>(input, output, fileList[i]);      </span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a>Below is an example of the clean image.</span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.show = "hold", out.width = "50%", fig.align = "default"}</span></span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a>magick<span class="sc">::</span><span class="fu">image_read</span>(<span class="st">"posts/_data/edited_b2041349x_001_Page_047.png"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a>  print</span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a>magick<span class="sc">::</span><span class="fu">image_read</span>(<span class="st">"posts/_data/1edited_b2041349x_001_Page_047.tif"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a>  magick<span class="sc">::</span><span class="fu">image_background</span>(<span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a>  print</span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part3: Tesseract OCR</span></span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a>It is possible to provide Tesseract with an updated dictionary as well as pages to OCR in its database. Users have to re-render the model after doing this. I tried to add just to the dictionary (using vocabulary I made which I will describe in my next blog post). Unfortunately, my computer crashed. Given greater computational resources, this would be an avenue to follow to improve the accuracy of the OCR. For the purposes of this pilot study, I instead used the following loop to save text to a separate file.</span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"/Users/emmanuelmiller/Desktop/text_ia"</span>)</span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a>temp<span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">files =</span> <span class="fu">list.files</span>())</span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a><span class="co">#ocr and save to files</span></span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(temp)){</span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a>  filename <span class="ot">&lt;-</span> temp<span class="sc">$</span>files[i]</span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> tesseract<span class="sc">::</span><span class="fu">ocr</span>(filename)</span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(dat, <span class="at">file =</span> <span class="fu">file</span>(<span class="fu">paste0</span>(<span class="fu">basename</span>(filename), <span class="st">".txt"</span>)), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a>Below is an example of some of the raw OCR data. I will demonstrate how I clean it in the next blog post.</span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval = F}</span></span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a>book_peek<span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">files =</span> <span class="fu">list.files</span>(<span class="st">"/Users/emmanuelmiller/Desktop/text_ia/"</span>,</span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">full.names =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-460"><a href="#cb31-460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">40</span><span class="sc">:</span><span class="dv">50</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-461"><a href="#cb31-461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dat =</span> <span class="fu">map</span>(files, <span class="sc">~</span><span class="fu">str_c</span>(<span class="fu">read_lines</span>(.), <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)),</span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a>         <span class="at">dat =</span> <span class="fu">str_sub</span>(dat, <span class="dv">0</span>, <span class="dv">250</span>),</span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a>         <span class="at">url =</span> <span class="fu">str_extract</span>(files, <span class="st">"(?&lt;=edit</span><span class="sc">\\</span><span class="st">w{0,3}_).*(?=_Page)"</span>),</span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a>         <span class="at">page =</span> <span class="fu">str_extract</span>(files, <span class="st">"(?&lt;=Page_)</span><span class="sc">\\</span><span class="st">d+"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-465"><a href="#cb31-465" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(url, page, dat) <span class="sc">%&gt;%</span> </span>
<span id="cb31-466"><a href="#cb31-466" aria-hidden="true" tabindex="-1"></a>  kable <span class="sc">%&gt;%</span> </span>
<span id="cb31-467"><a href="#cb31-467" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a><span class="co"># save(book_peek, file = "/Users/emmanuelmiller/Desktop/dacss697d/Text_as_Data_Fall_2022/posts/_data/book_peek.RData")</span></span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a>book_peek</span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a><span class="fu"># References</span></span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a>Goodrum H, Roberts K, Bernstam EV. Automatic classification of scanned electronic health record documents. Int J Med Inform. 2020 Dec;144:104302. doi: 10.1016/j.ijmedinf.2020.104302. Epub 2020 Oct 17. PMID: 33091829; PMCID: PMC7731898. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7731898/</span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a>Hsu E, Malagaris I, Kuo YF, Sultana R, Roberts K. Deep learning-based NLP data pipeline for EHR-scanned document information extraction. JAMIA Open. 2022 Jun 11;5(2):ooac045. doi: 10.1093/jamiaopen/ooac045. PMID: 35702624; PMCID: PMC9188320. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9188320/</span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a>Liu X, Meehan J, Tong W, Wu L, Xu X, Xu J. DLI-IT: a deep learning approach to drug label identification through image and text embedding. BMC Med Inform Decis Mak. 2020 Apr 15;20(1):68. doi: 10.1186/s12911-020-1078-3. PMID: 32293428; PMCID: PMC7158001. https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7158001/</span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a>Nguyen, A., O'Dwyer, J., Vu, T., Webb, P. M., Johnatty, S. E., &amp; Spurdle, A. B. (2020). Generating high-quality data abstractions from scanned clinical records: text-mining-assisted extraction of endometrial carcinoma pathology features as proof of principle. BMJ open, 10(6), e037740. https://doi.org/10.1136/bmjopen-2020-037740 https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7295399/</span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a>Rasmussen LV, Peissig PL, McCarty CA, Starren J. Development of an optical character recognition pipeline for handwritten form fields from an electronic health record. J Am Med Inform Assoc. 2012 Jun;19(e1):e90-5. doi: 10.1136/amiajnl-2011-000182. Epub 2011 Sep 2. PMID: 21890871; PMCID: PMC3392858.https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3392858/</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>